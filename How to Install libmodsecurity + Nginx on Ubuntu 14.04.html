<body role="document">
<div class="document">
<div class="documentwrapper">
<div class="body" role="main">
<div id="how-to-install-libmodsecurity-nginx-on-ubuntu-14-04">

<p><a class="reference external" href="https://www.modsecurity.org/">ModSecurity</a>, originally written as a web
application firewall (WAF) for Apache servers, is the de facto standard for
open-source WAF solutions. Recent work on the project has shifted focus toward
providing a generic shared library that any web server can use to protect
HTTP(S) requests. These instructions touch on building and configuring
libmodsecurity for a DreamCompute instance running Ubuntu 14.04.</p>
<div id="building-libmodsecurity">
<h2>Building libmodsecurity</h2>
<p>First, install the necessary packages and libraries used to build source
projects, as well as libraries used specifically by libmodsecurity:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># apt-get install automake gcc make pkg-config libtool g++ libfl-dev bison \
    build-essential libbison-dev libyajl-dev liblmdb-dev libpcre3-dev \
    libcurl4-openssl-dev libgeoip-dev libxml2-dev
</pre></div>
</div>
<p>Next, download and unpack the most recent source of libmodsecurity. This is
available from the ModSecurity GitHub project, on the <cite>libmodsecurity</cite> branch:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># git clone https://github.com/SpiderLabs/ModSecurity
Cloning into 'ModSecurity'...
remote: Counting objects: 20508, done.
remote: Compressing objects: 100% (72/72), done.
remote: Total 20508 (delta 16), reused 0 (delta 0), pack-reused 20435
Receiving objects: 100% (20508/20508), 33.93 MiB | 9.49 MiB/s, done.
Resolving deltas: 100% (14572/14572), done.
Checking connectivity... done.
# cd ModSecurity/
~/ModSecurity# git checkout -b origin/libmodsecurity
Switched to a new branch 'origin/libmodsecurity'
</pre></div>
</div>
<p>Initialize and update the git submodules that libmodsecurity requires:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>~/ModSecurity# git submodule init
~/ModSecurity# git submodule update
</pre></div>
</div>
<p>Finally, configure, build, and install the libmodsecurity library:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>~/ModSecurity# ./build.sh &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install
</pre></div>
</div>
</div>
<div id="building-nginx-with-libmodsecurity">
<h2>Building Nginx with libmodsecurity</h2>
<p>Now that libmodsecurity has been installed and is available to be used by
third-party programs, Nginx can be compiled with the ModSecurity-nginx connector
to load libmodsecurity and process requests.</p>
<p>First, grab the source for the Nginx module wraps around libmodsecurity:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span><span class="c1"># git clone https://github.com/SpiderLabs/ModSecurity-nginx.git</span>
</pre></div>
</div>
<p>Next, grab the Nginx source and verify it:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span><span class="c1"># wget http://nginx.org/download/nginx-1.10.1.tar.gz</span>
</pre></div>
</div>
<p>It’s also important to grab the developer’s signing key and verify the contents
of the download:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># gpg --keyserver pgp.mit.edu --recv a1c052f8
gpg: requesting key A1C052F8 from hkp server pgp.mit.edu
gpg: key A1C052F8: public key "Maxim Dounin &lt;mdounin@mdounin.ru&gt;" imported
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   3  signed:   5  trust: 0-, 0q, 0n, 0m, 0f, 3u
gpg: depth: 1  valid:   5  signed:   0  trust: 4-, 0q, 0n, 0m, 1f, 0u
gpg: next trustdb check due at 2017-11-22
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
</pre></div>
</div>
<p>Next, grab the signature for this tarball:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span><span class="c1"># wget http://nginx.org/download/nginx-1.10.1.tar.gz.asc</span>
</pre></div>
</div>
<p>And finally, verify the signature:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># gpg --verify nginx-1.10.1.tar.gz.asc nginx-1.10.1.tar.gz
gpg: Signature made Tue 31 May 2016 06:58:32 AM PDT using RSA key ID A1C052F8
gpg: Good signature from "Maxim Dounin &lt;mdounin@mdounin.ru&gt;"
Primary key fingerprint: B0F4 2533 73F8 F6F5 10D4  2178 520A 9993 A1C0 52F8
</pre></div>
</div>
<p>From here, configure Nginx with the <cite>–add-module=</cite> option, pointing to the
ModSecurity-nginx module that was previously downloaded:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># tar -zxf nginx-1.10.1.tar.gz
# cd nginx-1.10.1/
~/nginx-1.10.1# ls
    auto  CHANGES  CHANGES.ru  conf  configure
    contrib  html  LICENSE  man README  src

~/nginx-1.10.1# ./configure --add-module=/root/ModSecurity-nginx
</pre></div>
</div>
<p>From here, simply build and install Nginx:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>~/nginx-1.10.1# make &amp;&amp; make install
</pre></div>
</div>
</div>
<div id="configuring-libmodsecurity-in-nginx">
<h2>Configuring libmodsecurity in Nginx</h2>
<p>Adding libmodsecurity rules and configuration directives inside Nginx configs
is straightforward. Add the following to the Nginx configuration:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>modsecurity on;
modsecurity_rules '
    SecRuleEngine On
    SecDebugLog /tmp/modsec_debug.log
    SecDebugLogLevel 9
    SecRule ARGS "@streq test" "id:1,phase:1,deny,msg:\'test rule\'"
';
</pre></div>
</div>
<p>These directives can be added inside the <cite>http</cite> block, or one or more <cite>server</cite>
or <cite>location</cite> blocks. Once this is added, reload Nginx. This rule can now be
tested by sending a regular request to Nginx and examining the output:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># curl -D - -s -o /dev/null localhost/
HTTP/1.1 200 OK
Server: nginx/1.10.1
Date: Wed, 13 Jul 2016 18:06:15 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Wed, 13 Jul 2016 18:01:34 GMT
Connection: keep-alive
ETag: "578681fe-264"
Accept-Ranges: bytes
</pre></div>
</div>
<p>The single rule added via the <cite>modsecurity_rules</cite> directive will deny requests
that have the word <cite>test</cite> inside a GET or POST argument. This can be seen by
changing the curl test:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span># curl -D - -s -o /dev/null localhost/?a=test
HTTP/1.1 403 Forbidden
Server: nginx/1.10.1
Date: Wed, 13 Jul 2016 18:06:19 GMT
Content-Type: text/html
Content-Length: 169
Connection: keep-alive
</pre></div>
</div>
<p>A 403 response means that Nginx has blocked the request based on processing the
request with libmodsecurity. From here, libmodsecurity can be customized using
the available directives for ModSecurity (see the
<a class="reference external" href="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual">ModSecurity reference manual</a>
for more information).</p>
</div>
<div id="final-notes">
<h2>Final Notes</h2>
<p>It should be noted that libmodsecurity is still in active development, so
certain functionality is subject to change. As with any actively developed
open source project, be sure to check the source code for the most recent
releases.</p>
</div>
</div>
</div>
</div>
<div class="clearer"></div>
</div>
<div class="footer">
</div>
<!--DreamCompute Button-->
<div class="dream-sign-up">
<h2>Deploy Your Apps On Cloud Servers Today</h2>
<a href="http://www.dreamhost.com/cloud/computing">Sign Up for DreamCompute</a>
</div>
</body>
